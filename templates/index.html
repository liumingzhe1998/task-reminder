<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡æé†’ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ä»»åŠ¡æé†’">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">
</head>
<body>
    <!-- PWA å®‰è£…æç¤º -->
    <div id="pwa-install-prompt" class="pwa-install-banner" style="display: none;">
        <div class="pwa-install-content">
            <div class="pwa-install-text">
                <div class="pwa-install-icon">ğŸ“²</div>
                <div>
                    <div class="pwa-install-title">å®‰è£…åº”ç”¨</div>
                    <div class="pwa-install-desc">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒ</div>
                </div>
            </div>
            <button id="pwa-install-btn" class="pwa-install-button">å®‰è£…</button>
            <button id="pwa-install-close" class="pwa-install-close">âœ•</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ“‹ ä»»åŠ¡æé†’ç³»ç»Ÿ</h1>
            <p class="subtitle">ç®¡ç†æ‚¨çš„ä»»åŠ¡ï¼Œæ°¸ä¸é”™è¿‡é‡è¦äº‹é¡¹</p>
            <button id="manual-install-btn" class="install-prompt-btn" style="display: none;">
                ğŸ“± å®‰è£…åº”ç”¨
            </button>
        </header>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-container" id="stats">
            <div class="stat-item">
                <div class="stat-number" id="total-tasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pending-tasks">0</div>
                <div class="stat-label">è¿›è¡Œä¸­</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="urgent-tasks">0</div>
                <div class="stat-label">ç´§æ€¥</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="completed-tasks">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
        </div>

        <!-- æ·»åŠ ä»»åŠ¡è¡¨å• -->
        <div class="form-container">
            <h2>â• æ·»åŠ æ–°ä»»åŠ¡</h2>
            <form id="task-form">
                <div class="form-group">
                    <label for="title">ä»»åŠ¡æ ‡é¢˜ *</label>
                    <input type="text" id="title" name="title" placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜" required>
                </div>

                <div class="form-group">
                    <label for="description">ä»»åŠ¡æè¿°</label>
                    <textarea id="description" name="description" rows="3" placeholder="è¾“å…¥ä»»åŠ¡è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label for="deadline">æˆªæ­¢æ—¥æœŸ *</label>
                    <input type="date" id="deadline" name="deadline" required>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-icon">â•</span>
                    æ·»åŠ ä»»åŠ¡
                </button>
            </form>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="tasks-container">
            <div class="tasks-header">
                <h2>ğŸ“ ä»»åŠ¡åˆ—è¡¨</h2>
                <button class="btn btn-secondary" onclick="refreshTasks()">
                    <span class="btn-icon">ğŸ”„</span>
                    åˆ·æ–°
                </button>
            </div>

            <div id="tasks-list" class="tasks-list">
                <!-- ä»»åŠ¡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <p>æš‚æ— ä»»åŠ¡</p>
                    <p class="empty-hint">æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== PWA åŠŸèƒ½ ==========
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        const installBanner = document.getElementById('pwa-install-prompt');
        const installBtn = document.getElementById('pwa-install-btn');
        const closeBtn = document.getElementById('pwa-install-close');
        const manualInstallBtn = document.getElementById('manual-install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜»æ­¢é»˜è®¤çš„å®‰è£…æç¤º
            e.preventDefault();
            // ä¿å­˜äº‹ä»¶ä¾›åç»­ä½¿ç”¨
            deferredPrompt = e;

            // æ˜¾ç¤ºå®‰è£…æ¨ªå¹…
            installBanner.style.display = 'block';

            // æ˜¾ç¤ºæ‰‹åŠ¨å®‰è£…æŒ‰é’®ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
            if (manualInstallBtn) {
                manualInstallBtn.style.display = 'inline-flex';
            }

            console.log('æ£€æµ‹åˆ°å¯ä»¥å®‰è£… PWA');
        });

        // æ¨ªå¹…å®‰è£…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                }
                deferredPrompt = null;
                installBanner.style.display = 'none';
                if (manualInstallBtn) {
                    manualInstallBtn.style.display = 'none';
                }
            }
        });

        // æ‰‹åŠ¨å®‰è£…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (manualInstallBtn) {
            manualInstallBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                        alert('å®‰è£…æˆåŠŸï¼åœ¨ä¸»å±å¹•æ‰¾åˆ°åº”ç”¨å›¾æ ‡');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                    }
                    deferredPrompt = null;
                    installBanner.style.display = 'none';
                    manualInstallBtn.style.display = 'none';
                } else {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ PWA å®‰è£…ï¼Œè¯·ä½¿ç”¨ Chrome æµè§ˆå™¨');
                }
            });
        }

        closeBtn.addEventListener('click', () => {
            installBanner.style.display = 'none';
            // ä¸éšè—æ‰‹åŠ¨å®‰è£…æŒ‰é’®ï¼Œè®©ç”¨æˆ·è¿˜å¯ä»¥æ‰‹åŠ¨å®‰è£…
        });

        // æ£€æµ‹åº”ç”¨æ˜¯å¦å·²å®‰è£…
        window.addEventListener('appinstalled', () => {
            installBanner.style.display = 'none';
            if (manualInstallBtn) {
                manualInstallBtn.style.display = 'none';
            }
            console.log('åº”ç”¨å·²å®‰è£…åˆ°ä¸»å±å¹•');
            alert('åº”ç”¨å·²æˆåŠŸå®‰è£…åˆ°ä¸»å±å¹•ï¼');
        });

        // iOS è®¾å¤‡æç¤ºï¼ˆiOS ä¸æ”¯æŒ beforeinstallpromptï¼‰
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && !window.localStorage.getItem('ios-install-prompt-shown')) {
            setTimeout(() => {
                installBanner.style.display = 'block';
                installBtn.textContent = 'æŸ¥çœ‹è¯´æ˜';
                installBtn.onclick = () => {
                    alert('åœ¨ iOS ä¸Šå®‰è£…æ­¤åº”ç”¨:\n\n1. ç‚¹å‡»åº•éƒ¨çš„åˆ†äº«æŒ‰é’®\n2. å‘ä¸‹æ»šåŠ¨å¹¶ç‚¹å‡»"æ·»åŠ åˆ°ä¸»å±å¹•"\n3. ç‚¹å‡»"æ·»åŠ "æŒ‰é’®');
                    installBanner.style.display = 'none';
                    window.localStorage.setItem('ios-install-prompt-shown', 'true');
                };
            }, 2000);
        }

        // ========== åº”ç”¨åŠŸèƒ½ ==========
        // é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            loadStats();

            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„æœ€å°å€¼ä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deadline').setAttribute('min', today);
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('task-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const deadline = document.getElementById('deadline').value;

            if (!title || !deadline) {
                alert('è¯·å¡«å†™ä»»åŠ¡æ ‡é¢˜å’Œæˆªæ­¢æ—¥æœŸ');
                return;
            }

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        deadline: deadline
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('task-form').reset();
                    // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    loadTasks();
                    loadStats();
                    alert('ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æ·»åŠ ä»»åŠ¡æ—¶å‡ºé”™: ' + error.message);
            }
        });

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();

                if (data.success) {
                    displayTasks(data.tasks);
                } else {
                    console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
        function displayTasks(tasks) {
            const tasksList = document.getElementById('tasks-list');

            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>æš‚æ— ä»»åŠ¡</p>
                        <p class="empty-hint">æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</p>
                    </div>
                `;
                return;
            }

            tasksList.innerHTML = tasks.map(task => {
                const countdown = task.countdown || {};
                const statusClass = countdown.status || 'normal';
                const completedClass = task.completed ? 'completed' : '';
                const checkedAttr = task.completed ? 'checked' : '';

                return `
                    <div class="task-item ${statusClass} ${completedClass}" data-id="${task.id}">
                        <div class="task-header">
                            <div class="task-left">
                                <input type="checkbox" ${checkedAttr} onchange="toggleTask('${task.id}')">
                                <h3 class="task-title">${escapeHtml(task.title)}</h3>
                            </div>
                            <div class="countdown ${statusClass}">
                                ${escapeHtml(countdown.text || 'æœªçŸ¥')}
                            </div>
                        </div>

                        ${task.description ? `<p class="task-description">${escapeHtml(task.description)}</p>` : ''}

                        <div class="task-footer">
                            <div class="task-deadline">
                                <span class="icon">ğŸ“…</span>
                                æˆªæ­¢æ—¥æœŸ: ${escapeHtml(task.deadline)}
                            </div>
                            <button class="btn-delete" onclick="deleteTask('${task.id}')">
                                <span>ğŸ—‘ï¸</span> åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('total-tasks').textContent = data.stats.total;
                    document.getElementById('pending-tasks').textContent = data.stats.pending;
                    document.getElementById('urgent-tasks').textContent = data.stats.urgent;
                    document.getElementById('completed-tasks').textContent = data.stats.completed;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadTasks();
                    loadStats();
                    alert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('åˆ é™¤ä»»åŠ¡æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        async function toggleTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadTasks();
                    loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æ“ä½œæ—¶å‡ºé”™: ' + error.message);
            }
        }

        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        function refreshTasks() {
            loadTasks();
            loadStats();
        }

        // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
